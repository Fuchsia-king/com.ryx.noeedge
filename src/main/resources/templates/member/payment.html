<!DOCTYPE html>
<html lang="zh" xmlns:th="http://www.thymeleaf.org">

<head>
  <meta charset="UTF-8">

  <meta name="viewport" content="width=1920 initial-scale=1.0">

  <!-- First use the latest version of IE and Chrome -->
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
  <title>融易学</title>
  <!-- Keyword -->
  <!-- <meta name="keywords" content=""> -->
  <!-- describe -->
  <meta name="description" content="">

  <!-- 360 use Google Chrome Frame -->
  <meta name="renderer" content="webkit">
  <!-- Baidu prohibition of transcoding -->
  <meta http-equiv="Cache-Control" content="no-siteapp">
  <!-- Definition of web search engine index -->
  <meta name="robots" content="index,follow">
  <!-- ios -->
  <!-- The title that is added to the main screen -->
  <meta name="apple-mobile-web-app-title" content="">
  <!-- Whether WebApp full screen mode is enabled -->
  <meta content="yes" name="apple-mobile-web-app-capable">
  <meta content="yes" name="apple-touch-fullscreen">
  <!-- Setting the background color of the State Bar -->
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <!-- Android theme-color  Used to control the color of the tabs -->
  <meta name="theme-color" content="#747474">
  <meta name="mobile-web-app-capable" content="yes">
  <!-- Turn off the translation plug-in under the Chrome browser -->
  <meta name="google" value="notranslate" />
  <!-- uc Forced vertical screen -->
  <meta name="screen-orientation" content="portrait">
  <!-- QQ Forced vertical screen -->
  <meta name="x5-orientation" content="portrait">
  <!-- UC Mandatory full screen -->
  <meta name="full-screen" content="yes">
  <link rel="shortcut icon" href="favicon.ico" type="image/x-icon">
  <link href="/css/bootstrap.min.css" rel="stylesheet">
  <link href="/css/swiper.min.css" rel="stylesheet" type="text/css" />
  <link href="/css/public.css" rel="stylesheet">
  <link href="/css/inStyle.css" rel="stylesheet" type="text/css" />
  <link rel="stylesheet" type="text/css" href="/css/font-other.css" />
</head>

<body class="resetStyle">
  <div class="insside-header">
    <div class="container">
      <div class="head-middle">
        <div class="head-l">
          <div class="logo"><a href="/"><img src="/images/logo2.png"></a></div>
        </div>
        <div class="head-r">
          <div class="search-icon">
            <div class="search-input"><input type="text" placeholder=""></div>
            <button type="submit"><img src="/images/icon_search.png"></button>
          </div>
          <div class="info-box">
            <div class="record-text">
              <a href="">学习记录</a>
            </div>
            <div class="face-head" id="face-head1" style="display: none">
              <div class="img"><img src="/images/user/face_img.png"></div>
              <div class="userInfo">
                <div class="user-li"><a href="">刘强东</a></div>
                <div class="user-li"><a href="">订单中心</a></div>
                <div class="user-li"><a href="">个人设置</a></div>
                <div class="user-li"><a href="/logout" id="logout1">退出登录</a></div>
                <div class="triangle"></div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
  <div class="payment-main">
    <div class="container">
      <div class="state-box">
        <div class="state active">
          <div class="figure">1</div>
          <div class="font">订单支付</div>
        </div>
        <div class="state-m"></div>
        <div class="state">
          <div class="figure">2</div>
          <div class="font">支付完成</div>
        </div>
      </div>
      <div class="curriculum-box">
        <div class="table-head">
          <div class="th-name">课程名称</div>
          <div class="th-time">有效期</div>
          <div class="th-price">价格</div>
        </div>
        <div class="table-body">
          <div class="td">
            <a href="">
              <div class="td-name">
              <div class="main">
                <div class="flex-l">
                  <div class="pic"><img th:src="@{${course.image}}" ></div>
                </div>
                <div class="flex-r">
                  <div class="title" th:text="${course.title}"></div>
                  <div class="order-number" th:text="${'订单号：'+ order.id}"></div>
                </div>
              </div>
              </div>
              <div class="td-time" th:text="${course.avaiDay+'天'}"></div>
              <div class="td-price" th:text="${'¥'+course.price}"></div>
            </a>
          </div>
        </div>
      </div>
      <div class="mode-payment">
        <div class="payment-list" id="payment-list">
          <div class="item  active" th:style="${balance>0?'display:'+'':'display:'+'none'}">
            <input id="balance_pay" type="radio" name="pay" class="radio-input" checked/>
            <div class="border"></div>
            <div class="img"><img src="/images/payment/icon_bankcard.png"></div>
            <div class="balance gray">
              <span class="bmikece">余额支付</span>
              <span th:text="${'¥'+balance}"></span>
            </div>
          </div>
          <div class="item">
            <input id="weixin_pay" type="radio" name="pay" class="radio-input"/>
            <div class="border"></div>
            <div class="img"><img src="/images/payment/icon_weixin.png"></div>
          </div>
          <div class="item">
            <input id="alipay" type="radio" name="pay" class="radio-input" />
            <div class="border"></div>
            <div class="img"><img src="/images/payment/icon_zhifubao.png"></div>
          </div>
        </div>
        <div class="coupon-wrap">
          <div class="coupon">
            <div class="td one parent">
              <select id="coupon_select1">
                <option selected th:value="${canUsedCoupon}">
                <option value="0">
              </select>
              <div class="select-add">
                <input id ="coupon1" type="text" readonly th:value="${canUsedCoupon>0?canUsedCoupon:0}" th:placeholder="${canUsedCoupon>0?'请选择优惠券':'暂无可使用优惠券'}">
                <div class="lable-item" id="couponClick">
                  <div class="list-box" th:if="${canUsedCoupon>0}" th:data-val="${canUsedCoupon}" th:text="${'可使用优惠券金额:'+canUsedCoupon}"></div>
                  <div class="list-box" th:unless="${canUsedCoupon>0}" data-val="暂无可用优惠券">暂无优惠券</div>
                </div>
              </div>
            </div>
          </div>
          <div class="label-text">优惠券</div>
        </div>
        <div class="detail-box">
          <div class="detail">
            <div class="item">
              <div class="lable-l">总价：</div>
              <div class="lable-r" th:text="${'¥'+order.originalPrice}"></div>
            </div>
            <div class="item">
              <div class="lable-l">优惠券：</div>
              <div class="lable-r" id = "useCoupon1" th:text="${canUsedCoupon>0?'￥'+canUsedCoupon:''}"></div>
            </div>
            <div class="item">
              <div class="lable-l">余额抵扣：</div>
              <div class="lable-r" th:text="${'¥'+canUsedBalance}"></div>
            </div>
            <div class="total-price">
              <div class="lable-l">需付金额：</div>
              <div class="lable-r"><span class="small" th:text="${'¥'+requestAmount}"></span></div>
            </div>
          </div>
        </div>
        <div class="pay-btn">
          <button type="submit" id="paynow1">立即支付</button>
        </div>
        <div class="note-text">本站课程均属于虚拟商品，购买后无特殊原因，不支持退款</div>
        <div class="agreement">
          <label><input name="免费" type="checkbox" value="免费" checked /></label>
          购买课程，即代表同意<a href="" class="blue-text">《融易学金融学院服务协议》</a></div>
      </div>
      <div class="pay-wrap">
        <div class="img">
          <img src="/images/payment/icon_success.png" style="display: none" id="success_img">
          <img src="./images/payment/icon_err.png" style="display: none" id="error_img">
        </div>
        <div class="state-text">
          <span style="display: none" id="success_span">支付成功</span>
          <span style="display: none" id="error_span">支付失败</span >
        </div>
        <!-- <div class="state-desc">请核对并修改以下信息后，再重新提交。</div> -->
        <div class="info" style="display: none" id="success_info">
          <div class="item">
            <div class="lable-l" >订单编号：</div>
            <div class="lable-r" id="order_id1"></div>
          </div>
          <div class="item">
            <div class="lable-l" >支付方式：</div>
            <div class="lable-r" id="pay_way1"></div>
          </div>
          <div class="item">
            <div class="lable-l">支付时间：</div>
            <div class="lable-r" id="pay_time1"></div>
          </div>
          <div class="item">
            <div class="lable-l">支付金额：</div>
            <div class="lable-r" id="count1"></div>
          </div>
        </div>
        <div class="err-box" style="display: none">
          <div class="tit">您提交的内容可能有如下错误：</div>
          <div class="err-list">
            <div class="err-item">
              <img src="./images/payment/err.png">你的支付账户错误
            </div>
            <div class="err-item">
              <img src="./images/payment/err.png">你的账户余额不足
            </div>
          </div>
        </div>
        <div class="study-btn">
          <button type="submit" class="orange" style="display: none" id="success_btn">立即学习</button>
          <button type="submit" class="blue" style="display: none" id="error_btn">重新支付</button>
        </div>
      </div>
    </div>

  </div>
  <div class="footer" th:include="comm/footer :: comm_footer"></div>
<!--    <div class="modal fade" id="weixinScanPayModel" style="display: none">-->
<!--      <div class="modal-header">-->
<!--        <button type="button" class="close" data-dismiss="modal">-->
<!--          <i class="icon icon-close"></i>-->
<!--        </button>-->
<!--        <div class="title-m">微信扫码支付</div>-->
<!--      </div>-->
<!--      <div class="modal-body-m" id="weixinScanPayModelBody">-->
<!--        <input type="hidden" name="orderId" id="orderId" />-->
<!--        <div class="row-fluid sortable">-->
<!--          <img id="imgWinPay" style="width:59%;float:left" />-->
<!--          <img src="/images/weixin-phone-bg.png" style="width:39%;float:left;margin-top:10px"/>-->
<!--        </div>-->
<!--        <div class="row-fluid sortable" id="errorContainer" style="display:none">-->
<!--          <div class="alert-mm alert-error" style="float:none;" id="errorContent">正在检测支付状态...</div>-->
<!--        </div>-->
<!--      </div>-->
<!--      <div class="modal-footer-m">-->
<!--        <a href="#" class="btn" data-dismiss="modal">关闭</a>-->
<!--      </div>-->
<!--    </div>-->
    <div id="weixinScanPayModel" style="display: none">
      <img src="" id="imgWinPay" style="width: 50%"/>
<!--      <img src="/images/weixin-phone-bg.png" style="width: 39%"/>-->
      <p style="height:30px;background-color: #FFB6C1;font-size: 14px;color:#A42D00;text-align:left;padding-top:7px;padding-left: 5px;margin-bottom: 10px">尚未完成支付,请用微信扫码支付</p>
    </div>
  <script src="/js/jquery-2.1.1.min.js"  charset="utf-8"></script>
  <script src="/js/bootstrap.min.js"></script>
  <script src="/js/swiper.min.js"></script>
  <!-- privatjs -->
  <script  src="/js/public.js"></script>
  <script  src="/js/inMain.js"></script>
  <!--end-->
  <script  th:src="@{/js/jquery_form.js}"></script>
  <script  th:src="@{/js/jquery-cookie-1.4.1.min.js}"></script>
  <script src="/js/layer/layer.js"></script>
  <script>
    $(function (){
      if($('#face-head1')[0].style.display=='none') {
        //通过sessionId保持登录
        let un = '[[${session.user}]]';
        if ($.cookie('sessionId') && un) {
          $('#face-head1')[0].style.display = '';
        }
      }
      let amount = Number('[[${requestAmount}]]');
      let coupon = Number('[[${canUsedCoupon}]]');
      let orderId = '[[${order.id}]]';
      $('#paynow1').click(function (){
        if(amount>0){
          //支付宝支付
          if($('#alipay')[0].checked){
            if(coupon>0){
              window.location.href='/payByAlipay?orderId='+orderId+'&isUsingCoupon=true';
            }else{
              window.location.href='/payByAlipay?orderId='+orderId+'&isUsingCoupon=false';
            }
          }else if($('#weixin_pay')[0].checked){//微信支付
            let url='';
            if(coupon>0){
              url = "/payByWechat?orderId="+ orderId +"&isUsingCoupon=true";
              $('#imgWinPay').attr("src",url);
              // $.get(url,function (res){
              //
              //   console.log(res);
              // });
            }else{
              url = "/payByWechat?orderId="+ orderId +"&isUsingCoupon=false";
              $('#imgWinPay').attr("src",url);
              // $('#weixinScanPayModel')[0].style.display='';

              // $.get(url,function(res){
              //   alert(res);
              //   console.log(res);
              // });
            }
             if($('#imgWinPay').height!=0){
                 layer.open({
                   title:['微信扫码支付','font-size:18px;margin-left:0'],
                   type:1,
                   closeBtn:2,
                   shade:true,
                   zindex:999,
                   content:$('#weixinScanPayModel'),
                   offset: 'auto',
                   success: function(layero, index){
                   }
                 });
             }
          }else{
            layer.msg("请选择一种支付方式");
          }
        }else{
          let canUsedBalance = Number('[[${canUsedBalance}]]');
          if(canUsedBalance>0){
            let data = {"orderId":[[${order.id}]],"isUsingCoupon":true};
            $.post('pay_by_balance',data,function(res){
              console.log(res);
              if(res.status==2){
                $('#success_img')[0].style.display='';
                $('#success_span')[0].style.display='';
                $('#success_info')[0].style.display='';
                $('#success_btn')[0].style.display='';
                $('#order_id1').text(res.orderId);
                $('#pay_way1').text(res.payway);
                $('#pay_time1').text(res.paytime);
                $('#count1').text('￥'+res.count);
              }
            });
          }
        }
      });

      // $('#useCoupon1')[0].innerText = '¥'+$('#coupon1').val();
      $('#coupon1 input').change(function(){
        alert('来了');
        //显示使用的优惠券金额
        $('#useCoupon1')[0].innerText = '¥'+$('#coupon_select1').val();
      });

    });
  </script>
</body>


</html>